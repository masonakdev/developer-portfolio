services:
  # Frontend (Portfolio)
  frontend:
    image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
    container_name: portfolio-frontend
    restart: unless-stopped
    environment:
      VIRTUAL_HOST: ${DOMAIN_NAME},www.${DOMAIN_NAME}
      VIRTUAL_PORT: 80
      LETSENCRYPT_HOST: ${DOMAIN_NAME},www.${DOMAIN_NAME}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Nginx Proxy
  nginx-proxy:
    image: jwilder/nginx-proxy:alpine
    container_name: portfolio-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - certs:/etc/nginx/certs
      - vhost:/etc/nginx/vhost.d
      - html:/usr/share/nginx/html
    labels:
      - "com.github.nginx-proxy.nginx=true"
    depends_on:
      - frontend

  # Letâ€™s Encrypt
  letsencrypt:
    image: nginxproxy/acme-companion
    container_name: portfolio-letsencrypt
    restart: unless-stopped
    depends_on:
      - nginx-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - certs:/etc/nginx/certs
      - vhost:/etc/nginx/vhost.d
      - html:/usr/share/nginx/html
    environment:
      DEFAULT_EMAIL: ${LETSENCRYPT_EMAIL}
      NGINX_PROXY_CONTAINER: portfolio-proxy

  # Watchtower (auto-updates frontend when new images appear)
  watchtower:
    image: containrrr/watchtower:latest
    container_name: portfolio-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_POLL_INTERVAL=60
      - DOCKER_API_VERSION=1.52
    command: --cleanup portfolio-frontend

volumes:
  certs:
  vhost:
  html:
